<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <title>AI 星巴克广告生成器</title>
    <style>
        body { margin: 0; background: #000; color: #fff; font-family: 'Segoe UI', sans-serif; overflow: hidden; }
        
        #config { 
            position: absolute; top: 20px; left: 20px; z-index: 100; 
            background: rgba(20, 30, 20, 0.95); /* 星巴克深绿氛围 */
            padding: 25px; width: 300px; border-radius: 12px; border: 1px solid #00704A;
        }

        .input-group { margin-bottom: 15px; }
        label { display: block; font-size: 12px; color: #aaa; margin-bottom: 5px; }
        input[type=text] { 
            width: 100%; padding: 8px; background: #222; border: 1px solid #444; 
            color: #fff; border-radius: 4px; box-sizing: border-box;
        }
        input[type=file] {
            width: 100%; padding: 8px; background: #222; border: 1px dashed #00704A;
            color: #fff; border-radius: 4px; font-size: 11px; box-sizing: border-box;
        }

        button { 
            width: 100%; padding: 12px; margin-top: 10px;
            background: #00704A; /* 星巴克绿 */
            border: none; color: white; border-radius: 6px; 
            cursor: pointer; font-weight: bold; transition: 0.3s;
        }
        button:hover { background: #008f5e; }
        button:disabled { background: #333; cursor: not-allowed; }

        #status-log {
            margin-top: 15px; font-size: 11px; color: #ccc; 
            height: 150px; overflow-y: auto; background: #111; padding: 10px;
            font-family: monospace; border: 1px solid #333;
        }

        #ad-video { 
            position: absolute; top: 0; left: 0; width: 100vw; height: 100vh; 
            object-fit: cover; z-index: 1; background: #111;
        }
    </style>
</head>
<body>

    <div id="config">
        <h3 style="margin-top:0; color:#00d4ff;">☕ 澄澜AI 导演)</h3>
        
        <div class="input-group">
            <label>1. 品牌 (Brand)</label>
            <input type="text" id="brand" value="Starbucks">
        </div>
        <div class="input-group">
            <label>2. 产品 (Product)</label>
            <input type="text" id="product" value="Hot Latte">
        </div>
        <div class="input-group">
            <label>3. 产品参考图 (支持上传)</label>
            <input type="file" id="prod-img" accept="image/*">
            <div style="font-size:10px; color:#666; margin-top:3px;">
                *若网络不通，系统会自动使用公网星巴克图作为替补
            </div>
        </div>
        
        <button onclick="startGen()" id="gen-btn">开始生成</button>
        
        <div id="status-log">等待指令...</div>
    </div>

    <video id="ad-video" src="/static/videos/playlist.mp4" controls loop playsinline></video>

    <script>
        const logDiv = document.getElementById('status-log');
        const btn = document.getElementById('gen-btn');
        const video = document.getElementById('ad-video');

        function log(msg) {
            logDiv.innerHTML += `<div>> ${msg}</div>`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        async function startGen() {
            const imgInput = document.getElementById('prod-img');
            const brand = document.getElementById('brand').value;
            const product = document.getElementById('product').value;

            if(imgInput.files.length === 0) { alert("请上传一张参考图片！"); return; }

            btn.disabled = true;
            btn.innerText = "生成中...";
            logDiv.innerHTML = "";
            log("正在上传图片...");

            const formData = new FormData();
            formData.append('brand', brand);
            formData.append('product', product);
            formData.append('product_image', imgInput.files[0]);

            try {
                const res = await fetch('/update_playlist', { method: 'POST', body: formData });
                const data = await res.json();
                
                log("✅ 上传成功！");
                if (data.local_url.includes("127.0.0.1") || data.local_url.includes("localhost")) {
                    log("检测到本地环境，将自动切换公网替补图...");
                }
                
                log("Phase 1: AI 绘图 (Seedream)...");
                log("Phase 2: AI 视频生成 (Seedance)...");
                log("⏳ 全程约需 3-5 分钟...");

                // 轮询播放器
                let checks = 0;
                const timer = setInterval(() => {
                    checks++;
                    if(checks % 10 === 0) {
                        const newSrc = "/static/videos/playlist.mp4?t=" + Date.now();
                        const temp = document.createElement('video');
                        temp.onloadeddata = () => {
                            video.src = newSrc;
                            video.style.display = 'block';
                            video.play().catch(e=>{});
                            clearInterval(timer);
                            btn.disabled = false;
                            btn.innerText = "生成完成";
                            log("视频已自动播放！");
                        };
                        temp.src = newSrc;
                    }
                    if (checks === 15) log("...正在绘制 9 张关键帧...");
                    if (checks === 45) log("...分镜完成，正在生成动态视频...");
                    if (checks === 90) log("...正在进行最后的剪辑合成...");

                }, 1000);

            } catch (e) {
                console.error(e);
                log("❌ 请求失败");
                btn.disabled = false;
            }
        }
    </script>
</body>
</html>
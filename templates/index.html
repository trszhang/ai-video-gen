<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <title>æ¾„æ¾œAI - æ™ºèƒ½å¯¼æ¼”å°</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <style>
        :root { --main: #00d4ff; --bg: #0a0a0a; --glass: rgba(255,255,255,0.05); }
        body { margin: 0; background: var(--bg); color: #fff; font-family: 'Segoe UI', sans-serif; overflow: hidden; height: 100vh; display: flex; }
        
        /* å¸ƒå±€å®¹å™¨ */
        .container { display: flex; width: 100%; height: 100%; position: relative; z-index: 2; transition: 0.5s; }
        .split { flex: 1; display: flex; flex-direction: column; justify-content: center; align-items: center; padding: 40px; border-right: 1px solid rgba(255,255,255,0.1); transition: 0.3s; position: relative; }
        .split:last-child { border-right: none; }
        .split:hover { background: rgba(255,255,255,0.02); }

        /* å·¦ä¾§ï¼šæ‹–æ‹½åŒº */
        #drop-zone { border: 2px dashed #444; border-radius: 20px; width: 300px; height: 300px; display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; color: #666; cursor: pointer; transition: 0.3s; }
        #drop-zone.dragover { border-color: var(--main); color: var(--main); box-shadow: 0 0 30px rgba(0,212,255,0.1); }
        #drop-zone h3 { margin: 10px 0 5px 0; color: #fff; }

        /* å³ä¾§ï¼šäºŒç»´ç åŒº */
        #qr-container { background: #fff; padding: 20px; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        .mobile-hint { margin-top: 20px; text-align: center; color: #888; font-size: 14px; }

        /* è§†é¢‘æ’­æ”¾å±‚ (é»˜è®¤éšè—) */
        #video-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 10; background: #000; display: none; }
        video { width: 100%; height: 100%; object-fit: contain; }
        
        /* åŠ è½½å±‚ */
        #loading-layer { position: absolute; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.95); z-index: 5; display: none; flex-direction: column; align-items: center; justify-content: center; }
        .spinner { width: 60px; height: 60px; border: 6px solid #333; border-top-color: var(--main); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }

        .logo { position: absolute; top: 30px; left: 40px; font-size: 24px; font-weight: bold; letter-spacing: 2px; color: var(--main); }
        .btn-retry { position:absolute; bottom:30px; right:30px; padding:12px 30px; background:var(--main); border:none; cursor:pointer; font-weight:bold; border-radius: 30px; color: #000; z-index: 11; }
    </style>
</head>
<body>

    <div class="logo">DIRECTOR AI</div>

    <div id="video-layer">
        <video id="final-video" controls autoplay loop playsinline></video>
        <button class="btn-retry" onclick="location.reload()">CREATE NEW / å†æ¥ä¸€æ¡</button>
    </div>

    <div id="loading-layer">
        <div class="spinner"></div>
        <h2 id="status-title" style="margin-top:30px; color: #fff;">PROCESSING</h2>
        <p id="status-text" style="color: #666;">AI æ­£åœ¨æ¥æ”¶ä¿¡å·...</p>
    </div>

    <div class="container" id="main-ui">
        <div class="split">
            <div id="drop-zone">
                <span style="font-size:50px;">ğŸ“‚</span>
                <h3>Desktop Upload</h3>
                <p>ç‚¹å‡»æˆ–æ‹–æ‹½å›¾ç‰‡åˆ°è¿™é‡Œ<br>ç›´æ¥ç”Ÿæˆ</p>
                <input type="file" id="file-input" hidden accept="image/*">
            </div>
        </div>

        <div class="split">
            <div id="qr-container"></div>
            <div class="mobile-hint">
                <h3>Mobile Control</h3>
                <p>æ‰«æäºŒç»´ç  Â· æ‰‹æœºæ‹æ‘„ä¸Šä¼ </p>
                <code style="color:var(--main); font-size:12px;">ID: {{ session_id }}</code>
            </div>
        </div>
    </div>

    <script>
        const SESSION_ID = "{{ session_id }}";
        const MOBILE_URL = "{{ mobile_url }}";
        
        // 1. ç”ŸæˆäºŒç»´ç 
        new QRCode(document.getElementById("qr-container"), {
            text: MOBILE_URL,
            width: 180,
            height: 180,
            colorDark : "#000000",
            colorLight : "#ffffff",
            correctLevel : QRCode.CorrectLevel.H
        });

        // 2. çŠ¶æ€è½®è¯¢ (æ ¸å¿ƒé€»è¾‘)
        let isProcessing = false;
        
        // æ¯1.5ç§’æ£€æŸ¥ä¸€æ¬¡æ˜¯å¦æœ‰æ‰‹æœºä¸Šä¼ 
        const uploadCheckTimer = setInterval(async () => {
            if (isProcessing) return; 
            
            try {
                const res = await fetch(`/api/status/${SESSION_ID}`);
                const data = await res.json();
                
                if (data.status === 'processing' || data.status === 'completed') {
                    // æ£€æµ‹åˆ°æ‰‹æœºä¸Šä¼ æˆåŠŸï¼Œæˆ–è€…PCä¸Šä¼ æˆåŠŸ
                    enterProcessingMode();
                }
            } catch(e) { console.error(e); }
        }, 1500);

        function enterProcessingMode() {
            isProcessing = true;
            clearInterval(uploadCheckTimer); // åœæ­¢æ£€æŸ¥ä¸Šä¼ 
            
            showLoading("AI Vision Analysis", "æ­£åœ¨è§£æè§†è§‰æ•°æ®å¹¶ç”Ÿæˆåˆ†é•œ...");
            startResultPolling(); // å¼€å§‹æ£€æŸ¥ç”Ÿæˆç»“æœ
        }

        // è½®è¯¢ç”Ÿæˆç»“æœ
        function startResultPolling() {
            let dots = 0;
            const pollTimer = setInterval(async () => {
                // ç®€å•çš„æ–‡å­—åŠ¨æ•ˆ
                dots = (dots + 1) % 4;
                document.getElementById('status-text').innerText = "æ­£åœ¨æ¸²æŸ“ TVC è§†é¢‘" + ".".repeat(dots);

                try {
                    const res = await fetch(`/api/status/${SESSION_ID}`);
                    const data = await res.json();
                    
                    if (data.status === 'completed') {
                        clearInterval(pollTimer);
                        playVideo(data.video_url);
                    } else if (data.status === 'failed') {
                        clearInterval(pollTimer);
                        alert("Sora ç”Ÿæˆå¤±è´¥: " + data.msg);
                        location.reload();
                    }
                } catch(e) { console.error(e); }
            }, 3000); // Sora æ¯”è¾ƒæ…¢ï¼Œ3ç§’æŸ¥ä¸€æ¬¡å³å¯
        }

        // 3. UI åˆ‡æ¢é€»è¾‘
        function showLoading(title, sub) {
            document.getElementById('main-ui').style.filter = "blur(10px)";
            document.getElementById('loading-layer').style.display = "flex";
            document.getElementById('status-title').innerText = title;
            document.getElementById('status-text').innerText = sub;
        }

        function playVideo(url) {
            document.getElementById('loading-layer').style.display = "none";
            document.getElementById('main-ui').style.display = "none";
            const vLayer = document.getElementById('video-layer');
            vLayer.style.display = "block";
            const v = document.getElementById('final-video');
            v.src = url;
            // å°è¯•è‡ªåŠ¨æ’­æ”¾
            v.play().catch(e => console.log("Autoplay prevented"));
        }

        // 4. æ‹–æ‹½ä¸Šä¼ é€»è¾‘ (PCç«¯)
        const dz = document.getElementById('drop-zone');
        const inp = document.getElementById('file-input');

        dz.onclick = () => inp.click();
        dz.ondragover = (e) => { e.preventDefault(); dz.classList.add('dragover'); };
        dz.ondragleave = () => dz.classList.remove('dragover');
        dz.ondrop = (e) => {
            e.preventDefault();
            dz.classList.remove('dragover');
            if(e.dataTransfer.files.length) upload(e.dataTransfer.files[0]);
        };
        inp.onchange = (e) => { if(e.target.files.length) upload(e.target.files[0]); };

        async function upload(file) {
            showLoading("Uploading Asset", "æ­£åœ¨ä¸Šä¼ æœ¬åœ°ç´ æ...");
            const fd = new FormData();
            fd.append("file", file);
            fd.append("session_id", SESSION_ID);
            
            try {
                const res = await fetch('/api/upload', { method: 'POST', body: fd });
                if(res.ok) {
                    enterProcessingMode();
                } else {
                    alert("Upload Error");
                    location.reload();
                }
            } catch(e) {
                alert("Network Error");
                location.reload();
            }
        }
    </script>
</body>
</html>